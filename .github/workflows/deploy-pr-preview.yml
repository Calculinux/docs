name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/deploy-pr-preview.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v4
        with:
          python-version: 3.x
      
      - run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV
      
      - uses: actions/cache@v3
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Configure git for gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages --depth=1 || true
      
      - name: Build documentation
        run: mkdocs build
      
      - name: Deploy to PR preview directory
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Checkout gh-pages branch
          git checkout gh-pages || git checkout --orphan gh-pages
          
          # Remove existing content except pr-previews directory
          find . -maxdepth 1 ! -name '.git' ! -name 'pr-previews' ! -name '.' -exec rm -rf {} +
          
          # Create pr-previews directory if it doesn't exist
          mkdir -p pr-previews/pr-${PR_NUMBER}
          
          # Copy built site to pr-previews/pr-{number}
          cp -r site/* pr-previews/pr-${PR_NUMBER}/
          
          # Restore main site if it exists
          if git show origin/gh-pages:index.html > /dev/null 2>&1; then
            git checkout origin/gh-pages -- . || true
            # Re-copy the PR preview (in case it was overwritten)
            mkdir -p pr-previews/pr-${PR_NUMBER}
            cp -r site/* pr-previews/pr-${PR_NUMBER}/
          fi
          
          # Clean up the site directory
          rm -rf site
          
          # Add and commit
          git add pr-previews/pr-${PR_NUMBER}
          git commit -m "Deploy preview for PR #${PR_NUMBER}" || echo "No changes to commit"
          
          # Push to gh-pages
          git push origin gh-pages
      
      - name: Comment on PR with preview link
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const prNumber = process.env.PR_NUMBER;
            const previewUrl = `https://calculinux.github.io/docs/pr-previews/pr-${prNumber}/`;
            
            const comment = `## ðŸ“š Documentation Preview
            
            The documentation for this PR has been deployed!
            
            ðŸ”— **Preview URL:** ${previewUrl}
            
            The preview will be updated automatically when you push new commits.
            
            ---
            *This preview is deployed from the \`gh-pages\` branch in the \`pr-previews/pr-${prNumber}/\` directory.*`;
            
            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ“š Documentation Preview')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
